import{r as e}from"./p-4054c6de.js";import{A as t}from"./p-1c7b096a.js";class s{static getElementConfiguration(e){return JSON.parse(e.dataset.ssFreedomField)}static getObjectDataForFieldElement(e){const t=e.closest("[data-ss-freedom-object]"),s=JSON.parse(t.dataset.ssFreedomObject);return{class:s.class,id:s.id}}}class o{static getTinyMceConfigurations(){return window.NikRolls.SsFreedom.configurations}constructor(e=MutationObserver,s=document.documentElement,o=null){this.observer=new e(e=>this.observerCallback(e)),this.htmlElement=s,this.apiService=o||new t,this.getTinyMce()}observeDom(){this.observer.observe(this.htmlElement,{attributes:!0,childList:!0,subtree:!0}),Array.from(this.htmlElement.querySelectorAll("[data-ss-freedom-field]")).forEach(e=>this.initialiseEditorIfNecessary(e))}observerCallback(e){e.forEach(async e=>{"attributes"===e.type&&"data-ss-freedom-field"===e.attributeName?this.initialiseEditorIfNecessary(e.target):"childList"===e.type&&Array.from(e.addedNodes).forEach(e=>{if(e instanceof HTMLElement){const t=Array.from(e.querySelectorAll("[data-ss-freedom-field]"));e.dataset&&e.dataset.ssFreedomField&&t.push(e),t.forEach(e=>this.initialiseEditorIfNecessary(e))}}),(await this.tinyMce).editors.forEach(e=>{e.getBody()&&!document.body.contains(e.getBody())&&e.destroy()})})}async initialiseEditorIfNecessary(e){if(e.dataset.ssFreedomField&&!(await this.tinyMce).editors.find(t=>t.getBody()===e)){const t=s.getElementConfiguration(e);o.getTinyMceConfigurations()[t.type]&&await this.initialiseTinyMceConfiguration(t.type,e)}}async initialiseTinyMceConfiguration(e,t){const s=o.getTinyMceConfigurations(),i=[],n=Object.assign({},s.all,s[e],{target:t,setup:e=>i.forEach(t=>t(e)),init_instance_callback:e=>{e.on("Change",e=>this.onChange(e)),o.updateEmptyFlag(e)}});if(n.class_selection_options){const e=n.class_selection_options;delete n.class_selection_options,i.push(t=>this.createTinyMceOptionsMenu(t,e))}return t instanceof HTMLButtonElement&&i.push(e=>{t.addEventListener("click",e=>e.preventDefault()),t.addEventListener("keydown",t=>{"Space"===t.code&&(t.preventDefault(),e.insertContent(" "))})}),(await this.tinyMce).init(n)}getTinyMce(){this.tinyMce=new Promise(e=>{const t=window.setInterval(()=>{window.tinymce&&(window.clearInterval(t),e(window.tinymce))})})}async onChange(e){o.updateEmptyFlag(e.target),await this.updateCmsWithLatestData(e.target)}createTinyMceOptionsMenu(e,t){e.ui.registry.addMenuButton("classselectionoptions",{text:"Options",fetch:s=>{s(t.reduce((t,s)=>{const o=e.selection.getNode().closest(s.selector),i=e.getBody().contains(o);return o&&i&&t.push({type:"nestedmenuitem",text:s.name,getSubmenuItems:()=>{const e=s.classes,t=Object.keys(e),i=Object.values(e).filter(e=>!!e),n=t.find(t=>null===e[t]),a=t.find(t=>o.classList.contains(e[t]))||n;return t.map(t=>({type:"menuitem",text:t,icon:t===a?"checkmark":void 0,onAction:()=>{o.classList.remove(...i),e[t]&&o.classList.add(e[t])}}))}}),t},[]))}})}static updateEmptyFlag(e){const t=e.getBody();e.getContent().trim()?t.classList.remove("ss-freedom-empty"):t.classList.add("ss-freedom-empty")}async updateCmsWithLatestData(e){const t=s.getObjectDataForFieldElement(e.getBody()),o={};return o[s.getElementConfiguration(e.getBody()).name]=e.getContent(),await this.apiService.updateObject(t.class,t.id,o)}}class i{constructor(e){this.elementHovered=!1,this.popupHovered=!1,this.element=e,this.elementOverHandler=this.elementOverHandler.bind(this),this.elementLeaveHandler=this.elementLeaveHandler.bind(this),this.popupOverHandler=this.popupOverHandler.bind(this),this.popupLeaveHandler=this.popupLeaveHandler.bind(this),this.handleUpdate=this.debounce(this.handleUpdate.bind(this),0),this.setup()}setup(){this.element.addEventListener("mouseover",this.elementOverHandler)}destroy(){this.element.removeEventListener("mouseover",this.elementOverHandler),this.removeHoverState()}elementOverHandler(){this.elementHovered=!0,this.popupHovered=!1,this.handleUpdate()}elementLeaveHandler(){this.elementHovered=!1,this.handleUpdate()}popupOverHandler(){this.popupHovered=!0,this.handleUpdate()}popupLeaveHandler(){this.popupHovered=!1,this.handleUpdate()}handleUpdate(){const e=document.querySelector(["ss-freedom-object-options-button:hover","ss-freedom-object-options-panel:hover",".tox:hover"].join(","));e&&(this.popupHovered=!0,e.addEventListener("mouseleave",this.popupLeaveHandler)),!this.elementHovered&&!this.popupHovered||this.optionsButton?this.elementHovered||this.popupHovered||!this.optionsButton||this.removeHoverState():this.activateHoverState()}debounce(e,t){let s;return()=>{window.clearTimeout(s),s=window.setTimeout(e,t)}}activateHoverState(){const e=this.element.getBoundingClientRect();this.element.addEventListener("mouseleave",this.elementLeaveHandler),this.element.classList.add("ss-freedom-show-hidden-empty");const t=document.createElement("ss-freedom-object-options-button");this.configureObjectMetadata(t),t.style.position="absolute",t.style.top=e.top+window.scrollY+"px",t.style.right=document.body.clientWidth-e.right+window.scrollX+"px",document.body.appendChild(t),this.optionsButton=t}removeHoverState(){this.element.removeEventListener("mouseleave",this.elementLeaveHandler),this.element.classList.remove("ss-freedom-show-hidden-empty"),this.optionsButton&&(this.optionsButton.removeEventListener("mouseover",this.popupOverHandler),this.optionsButton.removeEventListener("mouseleave",this.popupLeaveHandler),this.optionsButton.remove(),delete this.optionsButton)}configureObjectMetadata(e){const t=s.getObjectDataForFieldElement(this.element);e.setAttribute("object-class",t.class),e.setAttribute("object-id",t.id)}}class n{constructor(e=MutationObserver,t=document.documentElement){this.observer=new e(e=>this.observerCallback(e)),this.htmlElement=t}observeDom(){this.observer.observe(this.htmlElement,{attributes:!0,childList:!0,subtree:!0}),Array.from(this.htmlElement.querySelectorAll("[data-ss-freedom-object]")).forEach(e=>this.wireObjectOptionsIfNecessary(e))}observerCallback(e){e.forEach(e=>{"attributes"===e.type&&"data-ss-freedom-object"===e.attributeName?this.wireObjectOptionsIfNecessary(e.target):"childList"===e.type&&Array.from(e.addedNodes).forEach(e=>{if(e instanceof HTMLElement){const t=Array.from(e.querySelectorAll("[data-ss-freedom-object]"));e.dataset&&e.dataset.ssFreedomObject&&t.push(e),t.forEach(e=>this.wireObjectOptionsIfNecessary(e))}})})}wireObjectOptionsIfNecessary(e){const t=JSON.parse(e.dataset.ssFreedomObject);t.hasOptions&&!e.ssFreedomObjectOptionsInstanceWrangler?e.ssFreedomObjectOptionsInstanceWrangler=new i(e):!t.hasOptions&&e.ssFreedomObjectOptionsInstanceWrangler&&(e.ssFreedomObjectOptionsInstanceWrangler.destroy(),delete e.ssFreedomObjectOptionsInstanceWrangler)}}class a{constructor(t){e(this,t)}componentWillLoad(){(new o).observeDom(),(new n).observeDom()}render(){}}export{a as ss_freedom_admin_widget};